import{H as b,f as P,cr as m,f7 as h,f8 as I,f9 as j,fa as x,fb as C,s as c,dN as L,fc as M,cx as D,fd as O,fe as V,a_ as Y,eS as W,eU as T}from"./test-Dp3_P59c.js";import{u as X}from"./geojson-49b60rv_.js";import{o as S,n as g}from"./xmlUtils-CtUoQO7q.js";const F="xlink:href",y="2.0.0",E="__esri_wfs_id__",z="wfs-layer:getWFSLayerTypeInfo-error",q="wfs-layer:empty-service",A="wfs-layer:feature-type-not-found",_="wfs-layer:geojson-not-supported",H="wfs-layer:kvp-encoding-not-supported",Q="wfs-layer:malformed-json",$="wfs-layer:unknown-geometry-type",J="wfs-layer:unknown-field-type",B="wfs-layer:unsupported-spatial-reference",K="wfs-layer:unsupported-wfs-version";async function he(a,t){const e=Z((await b(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:y,...t?.customParameters},signal:t?.signal})).data);return ae(a,e),e}function Z(a){const t=G(a);de(t),v(t);const e=t.firstElementChild,r=I(re(e));return{operations:te(e),get featureTypes(){return Array.from(r())},readFeatureTypes:r}}const ee=["json","application/json; subtype=geojson; charset=utf-8","application/json; subtype=geojson","application/json","geojson","application/geo+json"];function R(a){for(const t of ee){const e=a.findIndex((r=>r.toLowerCase()===t));if(e>=0)return a[e]}return null}function te(a){let t=!0;const e={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}},r=[],s=[];if(S(a,{OperationsMetadata:{Parameter:n=>{if(n.getAttribute("name")?.toLowerCase()==="outputformat")return{AllowedValues:{Value:({textContent:o})=>{o&&r.push(o)}}}},Operation:n=>{switch(n.getAttribute("name")){case"GetCapabilities":return{DCP:{HTTP:{Get:o=>{e.GetCapabilities.url=o.getAttribute(F)}}}};case"DescribeFeatureType":return{DCP:{HTTP:{Get:o=>{e.DescribeFeatureType.url=o.getAttribute(F)}}}};case"GetFeature":return{DCP:{HTTP:{Get:o=>{e.GetFeature.url=o.getAttribute(F)}}},Parameter:o=>{if(o.getAttribute("name")?.toLowerCase()==="outputformat")return{AllowedValues:{Value:({textContent:i})=>{i&&s.push(i)}}}}}}},Constraint:n=>{switch(n.getAttribute("name")){case"KVPEncoding":return{DefaultValue:o=>{t=o.textContent.toLowerCase()==="true"}};case"ImplementsResultPaging":return{DefaultValue:o=>{e.GetFeature.supportsPagination=o.textContent.toLowerCase()==="true"}}}}}}),e.GetFeature.outputFormat=R(s)??R(r),!t)throw new c(H,"WFS service doesn't support key/value pair (KVP) encoding");if(e.GetFeature.outputFormat==null)throw new c(_,"WFS service doesn't support GeoJSON output format");return e}function ae(a,t){j(a)&&(x(a,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=C(t.operations.DescribeFeatureType.url)),x(a,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=C(t.operations.GetFeature.url)))}function k(a){const t=parseInt(a.textContent?.match(/(?<wkid>\d+$)/i)?.groups?.wkid??"",10);if(!Number.isNaN(t))return t}function re(a){return g(a,{FeatureTypeList:{FeatureType:t=>{const e={typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",defaultSpatialReference:4326,supportedSpatialReferences:[]},r=new Set;return S(t,{Name:s=>{const{name:n,prefix:o}=w(s.textContent);e.typeName=`${o}:${n}`,e.name=n,e.namespacePrefix=o,e.namespaceUri=s.lookupNamespaceURI(o)},Abstract:s=>{e.description=s.textContent},Title:s=>{e.title=s.textContent},WGS84BoundingBox:s=>{e.extent=Y.fromJSON(ne(s))},DefaultCRS:s=>{const n=k(s);n&&(e.defaultSpatialReference=n,r.add(n))},OtherCRS:s=>{const n=k(s);n&&r.add(n)}}),e.title||(e.title=e.name),r.add(4326),e.supportedSpatialReferences.push(...r),e}}})}function ne(a){let t,e,r,s;for(const n of a.children)switch(n.localName){case"LowerCorner":[t,e]=n.textContent.split(" ").map((o=>Number.parseFloat(o)));break;case"UpperCorner":[r,s]=n.textContent.split(" ").map((o=>Number.parseFloat(o)))}return{xmin:t,ymin:e,xmax:r,ymax:s,spatialReference:W}}function se(a,t,e){return h(a,(r=>e?r.name===t&&r.namespaceUri===e:r.typeName===t||r.name===t))}async function Se(a,t,e,r={}){const{featureType:s,extent:n}=await oe(a,t,e,r),{spatialReference:o}=ge(a.operations.GetFeature.url,s,r.spatialReference),{fields:i,geometryType:u,swapXY:p,objectIdField:l,geometryField:f}=await ie(a,s,o,r);return{url:a.operations.GetCapabilities.url,name:s.name,namespaceUri:s.namespaceUri,fields:i,geometryField:f,geometryType:u,objectIdField:l,spatialReference:r.spatialReference??new P({wkid:s.defaultSpatialReference}),extent:n,swapXY:p,wfsCapabilities:a,customParameters:r.customParameters}}async function oe(a,t,e,r={}){const s=a.readFeatureTypes(),n=t?se(s,t,e):s.next().value,{spatialReference:o=new P({wkid:n?.defaultSpatialReference})}=r;if(n==null)throw t?new c(A,`The type '${t}' could not be found in the service`):new c(q,"The service is empty");let i=n.extent;if(i&&!L(i.spatialReference,o))try{await M(i.spatialReference,o,void 0,r),i=D(i,o)}catch{throw new c(B,"Projection not supported")}return{extent:i,spatialReference:o,featureType:n}}async function ie(a,t,e,r={}){const{typeName:s}=t,[n,o]=await Promise.allSettled([le(a.operations.DescribeFeatureType.url,s,r),pe(a,s,e,r)]),i=d=>new c(z,`An error occurred while getting info about the feature type '${s}'`,{error:d});if(n.status==="rejected")throw i(n.reason);if(o.status==="rejected")throw i(o.reason);const{fields:u,errors:p}=n.value??{},l=n.value?.geometryType||o.value?.geometryType,f=o.value?.swapXY??!1;if(l==null)throw new c($,`The geometry type could not be determined for type '${s}`,{typeName:s,geometryType:l,fields:u,errors:p});return{...ue(u??[]),geometryType:l,swapXY:f}}function ue(a){const t=a.find((r=>r.type==="geometry"));let e=a.find((r=>r.type==="oid"));return a=a.filter((r=>r.type!=="geometry")),e||(e=new m({name:E,type:"oid",alias:E}),a.unshift(e)),{geometryField:t?.name??null,objectIdField:e.name,fields:a}}async function pe(a,t,e,r={}){let s,n=!1;const[o,i]=await Promise.all([ye(a.operations.GetFeature.url,t,e,a.operations.GetFeature.outputFormat,{...r,count:1}),b(a.operations.GetFeature.url,{responseType:"text",query:N(t,e,void 0,{...r,count:1}),signal:r?.signal})]),u=o.type==="FeatureCollection"&&o.features[0]?.geometry;if(u){let p;switch(s=V.fromJSON(X(u.type)),u.type){case"Point":p=u.coordinates;break;case"LineString":case"MultiPoint":p=u.coordinates[0];break;case"MultiLineString":case"Polygon":p=u.coordinates[0][0];break;case"MultiPolygon":p=u.coordinates[0][0][0]}const l=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(i.data);if(l){const f=p[0].toFixed(3),d=p[1].toFixed(3),U=parseFloat(l[1]).toFixed(3);f===parseFloat(l[2]).toFixed(3)&&d===U&&(n=!0)}}return{geometryType:s,swapXY:n}}async function le(a,t,e){return ce(t,(await b(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:y,TYPENAME:t,TYPENAMES:t,...e?.customParameters},signal:e?.signal})).data)}function ce(a,t){const{name:e}=w(a),r=G(t);v(r);const s=h(g(r.firstElementChild,{element:n=>n}),(n=>n.getAttribute("name")===e));if(s!=null){const n=s.getAttribute("type"),o=n?h(g(r.firstElementChild,{complexType:i=>i}),(i=>i.getAttribute("name")===w(n).name)):h(g(s,{complexType:i=>i}),(()=>!0));if(o)return me(o)}throw new c(A,`Type '${a}' not found in document`,{document:new XMLSerializer().serializeToString(r)})}const fe=new Set(["objectid","fid"]);function me(a){const t=[],e=[];let r;const s=g(a,{complexContent:{extension:{sequence:{element:n=>n}}}});for(const n of s){const o=n.getAttribute("name");if(!o)continue;let i,u;if(n.hasAttribute("type")?i=w(n.getAttribute("type")).name:S(n,{simpleType:{restriction:f=>(i=w(f.getAttribute("base")).name,{maxLength:d=>{u=+d.getAttribute("value")}})}}),!i)continue;const p=n.getAttribute("nillable")==="true";let l=!1;switch(i.toLowerCase()){case"integer":case"nonpositiveinteger":case"negativeinteger":case"long":case"int":case"short":case"byte":case"nonnegativeinteger":case"unsignedlong":case"unsignedint":case"unsignedshort":case"unsignedbyte":case"positiveinteger":e.push(new m({name:o,alias:o,type:"integer",nullable:p,length:T("integer")}));break;case"float":case"double":case"decimal":e.push(new m({name:o,alias:o,type:"double",nullable:p,length:T("double")}));break;case"boolean":case"string":case"gyearmonth":case"gyear":case"gmonthday":case"gday":case"gmonth":case"anyuri":case"qname":case"notation":case"normalizedstring":case"token":case"language":case"idrefs":case"entities":case"nmtoken":case"nmtokens":case"name":case"ncname":case"id":case"idref":case"entity":case"duration":case"time":e.push(new m({name:o,alias:o,type:"string",nullable:p,length:u??T("string")}));break;case"datetime":case"date":e.push(new m({name:o,alias:o,type:"date",nullable:p,length:u??T("date")}));break;case"pointpropertytype":r="point",l=!0;break;case"multipointpropertytype":r="multipoint",l=!0;break;case"curvepropertytype":case"multicurvepropertytype":case"multilinestringpropertytype":r="polyline",l=!0;break;case"surfacepropertytype":case"multisurfacepropertytype":case"multipolygonpropertytype":r="polygon",l=!0;break;case"geometrypropertytype":case"multigeometrypropertytype":l=!0,t.push(new c($,`geometry type '${i}' is not supported`,{type:new XMLSerializer().serializeToString(a)}));break;default:t.push(new c(J,`Unknown field type '${i}'`,{type:new XMLSerializer().serializeToString(a)}))}l&&e.push(new m({name:o,alias:o,type:"geometry",nullable:p}))}for(const n of e)if(n.type==="integer"&&!n.nullable&&fe.has(n.name.toLowerCase())){n.type="oid";break}return{geometryType:r,fields:e,errors:t}}async function ye(a,t,e,r,s){let{data:n}=await b(a,{responseType:"text",query:N(t,e,r,s),signal:s?.signal});n=n.replaceAll(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{return JSON.parse(n)}catch(o){throw new c(Q,"Error while parsing theÂ response",{response:n,error:o})}}function N(a,t,e,r){const s=typeof t=="number"?t:t.wkid;return{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:y,TYPENAMES:a,OUTPUTFORMAT:e,SRSNAME:"EPSG:"+s,STARTINDEX:r?.startIndex,COUNT:r?.count,...r?.customParameters}}async function Fe(a,t,e){const r=await b(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:y,TYPENAMES:t,RESULTTYPE:"hits",...e?.customParameters},signal:e?.signal}),s=/numberMatched=["'](?<numberMatched>\d+)["']/gi.exec(r.data);if(s?.groups)return+s.groups.numberMatched}function G(a){return new DOMParser().parseFromString(a.trim(),"text/xml")}function w(a){const[t,e]=a.split(":");return{prefix:e?t:"",name:e??t}}function de(a){const t=a.firstElementChild?.getAttribute("version");if(t&&t!==y)throw new c(K,`Unsupported WFS version ${t}. Supported version: ${y}`)}function v(a){let t="",e="";if(S(a.firstElementChild,{Exception:r=>(t=r.getAttribute("exceptionCode"),{ExceptionText:s=>{e=s.textContent}})}),t)throw new c(`wfs-layer:${t}`,e)}function ge(a,t,e){const r={wkid:t.defaultSpatialReference},s=e?.wkid!=null?{wkid:e.wkid}:r;return{spatialReference:s,getFeatureSpatialReference:O(a)||s.wkid&&t.supportedSpatialReferences.includes(s.wkid)?{wkid:s.wkid}:{wkid:t.defaultSpatialReference}}}export{E as F,ye as K,Se as W,se as Y,Fe as e,ge as o,he as v,ue as z};
